# NGINX Reverse Proxy Configuration
# Acts as the single public entry point for the API gateway
# Frontend never calls external APIs directly - everything goes through NGINX

# Define upstream gateway instances (load balancing)
upstream gateway_pool {
    least_conn;               # send request to the least busy backend
    server gateway1:8000;     # Gateway instance 1
    server gateway2:8000;     # Gateway instance 2
}

# Rate limiting zone
limit_req_zone $binary_remote_addr zone=one:10m rate=5r/s;

# Enable caching (optional, mainly for GET endpoints)
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=50m inactive=10m use_temp_path=off;

# Server block for HTTP
server {
    listen 80;
    server_name _;

    # Root health check
    location / {
        return 200 "API Gateway - Reverse Proxy Active";
        add_header Content-Type text/plain;
    }

    # Main API gateway endpoint
    location /api/state {
        rewrite ^/api(.*)$ $1 break;
        limit_req zone=one burst=10 nodelay;         # rate limiting
        proxy_pass http://gateway_pool;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Caching (uncomment for GET endpoints)
        # proxy_cache my_cache;
        # proxy_cache_valid 200 10s;
        # proxy_cache_use_stale error timeout updating;

        # Timeout for slow backend APIs
        proxy_read_timeout 30s;
        proxy_connect_timeout 10s;
    }

    # Health check endpoint
    location /api/health {
        rewrite ^/api(.*)$ $1 break;
        proxy_pass http://gateway_pool;
        proxy_set_header Host $host;
    }

    # Enable Gzip compression for better performance
    gzip on;
    gzip_types text/plain application/json text/css application/javascript;
    add_header X-Gateway $upstream_addr;
}